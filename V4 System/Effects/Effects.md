Эффекты - это самый базовый концепт системы днд. Любая способность в днд является либо действием, либо эффектом. Причём действия часто дают какой-то эффект.

Для начала приведём пример самого простого эффекта:

``` showLineNumbers
GET /api/v4/effects?name="simple_effect"

{
	"name": "simple_effect",
	"russian_name": "Простой эффект",
	"description": "Вы получаете владение Убеждением",
	"effect_duration": "pure", // pure | temp ... В данном случае - чистый эффект, остающийся навсегда
	"effect_activeness": "one-time", // passive | active | one-time ... В данном случае - срабатывающий один раз при наложении
    "effect_source": "race", // race | class | item | backstory | environment  ... В данном случае - от расы
    "effect_source_id": "{MOUNTAIN_DWARF_UUID}",
	"effect_target": "self", // self | AoE | allies | enemies ... В данном случае действует на носителя
	"effect_type": "proficiency", // Описаны далее ... В данном случае - даёт владение
	"proficiencies": { // список владений
		"skills": [ // даёт владение в навыках
			"persuasion" // владение в навыке убеждения
		]
	}
}
```

На основе этого примера мы рассмотрим более сложные эффекты. Например, эффект, который после наложения даёт владение в Убеждении на 5 ходов:

``` showLineNumbers
GET /api/v4/effects?name="temp_effect"

{
	"name": "temp_effect",
	"russian_name": "Простой эффект",
	"description": "Вы получаете владение Убеждением",
	"effect_duration": "temp", // pure | temp ... В данном случае - временный эффект, исчезающий через время
	"duration_type": "time",
	"duration_time": {
		"value": 5,
		"measure": "turn"
	},
	"effect_activeness": "passive", // passive | active | one-time ... В данном случае - работающий пассивно в рамках активности
    "effect_source": "race", // race | class | item | backstory | environment  ... В данном случае - от расы
    "effect_source_id": "{MOUNTAIN_DWARF_UUID}",
	"effect_target": "self", // self | AoE | allies | enemies ... В данном случае действует на носителя
	"effect_type": "proficiency", // Описаны далее ... В данном случае - даёт владение
	"proficiencies": { // список владений
		"skills": [ // даёт владение в навыках
			"persuasion" // владение в навыке убеждения
		]
	}
}
```

Разберём различные duration\_type для temp эффектов:

{% cut "PURE" %}

Чистые эффекты, которые невозможно снять или отменить. Лучше делать их one-time, если возможно, так как откатить их будет сложно.

{% endcut %}

{% cut "TIME" %}

Работают определённое время, после чего снимаются, например 2 раунда. Требует duration\_time в структуре эффекта для валидации. duration\_time.value это количество измерений, которым необходимо пройти, чтобы эффект спал. Вот возможные duration\_time.measure:

- turn - ходы
- round - раунды
- short rest - короткие отдыхи
- long rest - долгие отдыхи
- attacks - атаки effect\_target's

{% endcut %}

{% cut "RESOURCE" %}

Работают в зависимости от определённого ресурса, например, пока зарядов ярости \> 2. Проверяется в конце каждого хода, пока эффект активен. Структура:

``` showLineNumbers
"duration_type": "resource",
"duration_resource": {
  "name": "rage_charge",
  "operator": ">",
  "value": 2
}
```

{% endcut %}

{% cut "ITEM\_EQUIPPED" %}

Работают пока определённый предмет экипирован. Проверяется в конце каждого хода, пока эффект активен.
Структура:

``` showLineNumbers
"duration_type": "item_equipped",
"duration_item": "{ITEM_UUID}"
```

{% endcut %}

{% cut "UNTIL\_DISPELLED" %}

Работают, пока не будут сняты мастером, действием или другим эффектом. В основном так действуют благословения и проклятия

{% endcut %}

Посмотрим внимательно на effect\_activeness, он может принимать следующие значения

- passive - пассивные эффекты, работающие постоянно и без триггеров
- active - активные эффекты, срабатывающие по триггеру
- one-time - эффекты, срабатывающие при наложении и рассеивающиеся

&nbsp;

#### Действия эффектов

Переходим к сути, на что же влияют эффекты и как их применять к персонажу. Вот список effect\_type с примерами и описанием.

{% cut "Proficiency" %}

Эффекты такого типа выдают новые владения персонажам. Если был выбран "effect\_type": "proficiency", то после обязано находится одно из четырёх полей:

- proficiency - добавляет персонажу владение (записывается в proficiency персонажа, если такого ещё нет)
- expertise - добавляет персонажу компетенцию (записывается в expertise персонажа, если такой ещё нет)
- remove\_proficiency - убирает у персонажа владение (удаляет из proficiency персонажа, если есть такой)
- remove\_expertise - убирает у персонажа компетенцию (удаляет из expertise персонажа, если есть така)

{% endcut %}

{% cut "\{name\}\_roll\_modifier" %}

\{name\} может быть одним из следующих: attack, damage, skill, saving\_throw

Такие эффекты влияют на результат конкретной проверки, указанной в name. После такого обязательно должен идти modifier\_type.

Он может принимать следующие значения: add, multiply, advantage, disadvantage, reroll

- **add**
  В поле modifier указано число (int), которое добавляется к итоговому результату проверки (например "\+2" или "-1" или переменная "\{ATTACK\_ATTRIBUTE\_MODIFIER\}")

- **multiply**
  В поле modifier указано число (float), на которое умножается итоговый результат проверки (например 0,1 или 3 или переменная "\{PROFICIENCY\_BONUS\}")

- **advantage/disadvantage**
  Применяет преимущество или помеху к броску соответственно. Преимущество - совершаются два броска и выбирается лучший. Помеха - совершаются два броска и выбирается худший. На один бросок не могут действовать больше одного преимущества, как и помехи. Если на бросок действуют и помеха, и преимущество - он совершается как обычно.

- **reroll**
  Перебросит определённые значения кубика(-ов) при выпадении, после него всегда идёт поле reroll с набором правил:

  ``` showLineNumbers
  "reroll": {
      "reroll_count": 1, // сколько раз можно перебросить неустраиваюший результат на кубике
      "reroll_results": [1, 2] // какие результаты на кубике не устраивают
  }
  ```

{% endcut %}

{% cut "Resistance" %}

Выдаёт resistances в описываемой дальше структуре в поле "resistances"

{% endcut %}

{% cut "speed\_modifier" %}

Добавить указанный модификатор к скорости персонажа.

{% endcut %}

{% cut "armor\_class\_modifier" %}

Добавить выбранное значение к armor\_class персонажа

{% endcut %}

В будущем будут добавлены новые действия эффектов, сейчас остановимся на этих.

#### Активные эффекты

Кроме пассивных эффектов есть активные - они применяются в соответсвующих условиях. Вот лишь некоторые из них:

- При получении урона
- При промахе оружием
- Перед броском атаки
- После броска атаки
- и т.д.

Этот сегмент эффектов пока прорабатывается, но нужно иметь ввиду наличие таких в будущем.

Ярким представителем такого эффекта будет effect\_reckless\_attack - безрассудная атака Варвара, позволяющая получить преимущество на броски атаки, перед первым ударом в бою:

``` showLineNumbers
GET /api/v4/effects?name="effect_reckless_attack"

{
	"name": "effect_reckless_attack",
	"russian_name": "Безрассудный удар",
	"description": "Перед атакой вы можете решить сделать её с преимуществом. В этом случае удары по вам до начала вашего хода также будут с преимуществом",
	"effect_duration": "pure",
	"effect_source": "class",
	"effect_source_id": "{BARBARIAN_UUID}",
	"trigger": "before_attack",
	"trigger_description": "Перед атакой вы можете решить сделать её с преимуществом. В этом случае удары по вам до начала вашего хода также будут с преимуществом",
	"trigger_conditions": [
		{
			"condition_type": "attack_range",
			"operator": "==",
			"value": "melee"
		},
		{
			"condition_type": "user_choice",
			"operator": "==",
			"value": "true"
		}
	],
	"trigger_effects": [
		{
			"effect_type": "grant_effect",
			"effect_name": "effect_reckless_attack_advantage",
		},
		{
			"effect_type": "grant_effect",
			"effect_name": "effect_reckless_attack_disadvantage",
		}
	]
	"effect_activeness": "active",
	"effect_target": "self",
	"effect_type": "proficiency",
	"proficiencies": {
		"armor": [
			"light_armor",
			"medium_armor"
		]
	}
}

{
	"name": "effect_reckless_attack_advantage",
	"russian_name": "Преимущество безрассудного удара",
	"effect_duration": "temporary",
	"effect_source": "effect",
	"effect_source_id": "effect_reckless_attack",
	"duration": "until_start_of_turn",
	conditions: [
		{
			"condition_type": "attack_range",
			"operator": "==",
			"value": "melee"
		}
	],
	"effect_type": "attack_roll_modifier",
	"modifier": "advantage",
}

{
	"name": "effect_reckless_attack_disadvantage",
	"russian_name": "Недостаток безрассудного удара",
	"effect_duration": "temporary",
	"effect_source": "effect",
	"effect_source_id": "effect_reckless_attack",
	"duration": "until_start_of_turn",
	"effect_type": "attack_against_target_modifier",
	"value": "advantage",
}
```

(Дополняется, структура приведена примерная)

Для активных эффектов используются секции trigger\_conditions и trigger\_effects.

Принципиальное отличие пассивных эффектов от активных являются 2 вещи:

- Чаще всего активные эффекты требуют согласия пользователя (например, как в примере выше, перед совершением атаки бекенд вернёт такой ответ

  ``` showLineNumbers
  {
  	"result_type": "choice_needed",
  	"result": "Можно применить безрассудную атаку, чтобы применить повторите действие с параметром запроса ?effect_reckless_attack=True, иначе с параметром ?effect_reckless_attack=False"
  }
  ```

  При согласии он применит эффект безрассудной атаки и все атаки ближнего боя до конца раунда персонажем будут осуществляться с преимуществом

- Чаще всего активные эффекты не просто дают какой-то бонус, а применяют новые эффекты на персонажа/совершают дополнительное бесплатное действие/дают одиночный немедленный эффект (такой как лечение, например)

&nbsp;

#### Как работают эффекты и как их применять. Приоритет применения эффектов.

play-версия персонажа это pure-персонаж \+ все временные эффекты на нём.

Как применять эффекты:

- proficiency - добавить к существующим proficiency персонажа.
- speed\_modifier - добавить скорость к существующей скорости персонажа
- armor\_class\_modifier - добавить защиту к существующему КД персонажа
- \{name\}\_roll\_modifier - проверять соответствие условий и применять эффекты перед непосредственным выполнением проверки name - атаки, броска урона, проверки характеристики или спасброска. Они применяются всегда в таком порядке:
  * advantage/disadvantage - совершить бросок с преимуществом/помехой по правилам, описанным выше
  * reroll - совершить бросок и перебросить указанное количество раз неподходящие кубики
  * add/multiply - добавить/умножить результат броска на указанное значение
- resistances - добавить к существующим resistances персонажа.

Когда применять эффекты:

- Проверять возможность применения эффекта сразу при получении эффекта. Если условия удовлетворены - пересчитать персонажа с учётом нового эффекта.
- Пересчитывать возможность применения эффекта при совершении действия/в конце хода.

На бекенде хранится две версии персонажа - pure и последняя рассчитанная play с отметкой, какие эффекты уже применены, а какие нет.

Под пересчитыванием персонажа имеется ввиду проверка наложенных эффектов:

- Если все действующие эффекты продолжают действовать по условию, а новые эффекты не наложены, так как не подходят по условию - play-версия остаётся актуальной, её не нужно менять.
- Если все действующие эффекты продолжают действовать по условию, и добавились новые эффекты - нужно итеративно добавить их в play-версию, и считать её актуальной.
- Если один из эффектов перестал действовать, при этом его тип был не \{name\}\_roll\_modifier - возможно, что-то изменилось, play-версия неактуальна, берём pure и накладываем на неё эффекты, подходящие по условию.
- Если персонаж снял/надел предмет - play-версия неактуальна,  берём pure и накладываем на неё эффекты, подходящие по условию.

&nbsp;

Из этого следует, что бекенд должен уметь быстро анализировать, накладывать эффекты и пересчитывать play-версию. Нужно учесть это при реализации.